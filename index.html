<!DOCTYPE html>
<html>
<head>
	<!-- META -->
	<title>Begrebsbase</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<meta name="description" content="Database over faglige begreber" />
  <meta name="google-signin-clientid" content="307014362498-50ima1junno67dvj6ebviug5mfq8sbca.apps.googleusercontent.com" />
  <meta name="google-signin-scope" content="email" />
  <meta name="google-signin-cookiepolicy" content="http://twobias.synology.me" />
  <meta name="google-signin-callback" content="signinCallback" />

	<!-- CSS -->
	<link rel="stylesheet" type="text/css" href="css/colorbox.css" media="all" />
	<link rel="stylesheet" type="text/css" href="css/kickstart.css" media="all" />
	<link rel="stylesheet" type="text/css" href="css/jquery-ui.css" media="all" />
	<link rel="stylesheet" href="css/hint.css" />
	<link rel="stylesheet" type="text/css" href="style.css" media="all" />
	
	
	
	<!-- Javascript -->
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://code.jquery.com/ui/1.11.2/jquery-ui.min.js"></script>
	<script type="text/javascript" src="js/kickstart.js"></script>
	<script type="text/javascript" src="js/jquery.colorbox-min.js"></script>
  <script src="https://apis.google.com/js/client:platform.js?onload=render" async defer></script>
</head>
<body onload="initialize ()">

<!-- <div id="header">Tobias arbejder for øjeblikket på serveren - siden kan derfor være ustabil</div> -->

<div class="grid">
	<div class="col_12" style="margin: 0;"> <!--top row-->
    <div class="col_9">
  		<input id="searchbox" class="col_6" type="search" placeholder="Begreb du vil søge efter eller oprette"/>
      <button id="opretButton" data-hint="Opret nyt begreb" class="hint--bottom hint--no-animate small green icon-plus" onclick="opret()" style="top: 3px; display: none;"> Opret</button>
      <span data-hint="Hent opdateringer fra basen" class="hint--bottom hint--no-animate"><button id="opdaterButton" class="small blue icon-refresh" onclick="refresh()" style="margin-left: 1em; top: 3px;"></button></span>
      <span style="margin-left: 1.25em; vertical-align: middle;"><div class="icon-tags" style="opacity: 0.75; color: #06f;"></div></span><input type="search" id="tagsearchbox" class="col_3" placeholder="tag du vil filtrere efter" />
      <span class="hint--bottom hint--no-animate" data-hint="Kommentér på udviklingen af begrebsbasen"><a id="comment" class="icon-comments icon-large" href="https://docs.google.com/document/d/1E9ujAWe9Ao2ilaBFKTJy1nak6JGuiTIv6mTjhtZ40MQ/edit" target="_blank"></a></span>
      <div class="col_12" style="margin-bottom: 0;">
        <span id="sortering" style="opacity: 0.5; font-family: Verdana, Arial, Sans-serif; font-size: 0.64em;">Sortér begreber efter:</span>
        <button id="SortAbc" onClick="sort('abc')" class="hint--bottom hint--no-animate small" style="cursor: pointer; font-size: 0.512em;" data-hint="Sorter alfabetisk med A øverst"> Abc</button>
        <button id="SortCba" onClick="sort('cba')" class="hint--bottom hint--no-animate small" style="cursor: pointer; font-size: 0.512em;" data-hint="Sorter alfabetisk med A nederst"> Åøæ</button>
        <button id="Sort123" onClick="sort('123')" class="hint--bottom hint--no-animate small" style="cursor: pointer; font-size: 0.512em;" data-hint="Sorter med nyest opdaterede begreb øverst"> 1sek</button>
        <button id="Sort321" onClick="sort('321')" class="hint--bottom hint--no-animate small" style="cursor: pointer; font-size: 0.512em;" data-hint="Sorter med nyest opdaterede begreb nederst"> 99år</button>
      </div>
  	</div><!-- End left column -->
    <div class="col_3" style="padding: 10px; opacity: 1;">
      <span id="status"></span>
      <button id="signin" data-hint="log på for at redigere begrebsbasen" style="display: none;" class="hint--bottom hint--no-animate small green">log på</button>
      <span id="signout" style="display: none;" onClick="signOut()" data-hint="log af" class="hint--bottom hint--no-animate"><i style="color: red;" class="icon-signout"></i></span>
    </div><!-- End right column -->
  </div><!--End header row-->

  <div class="col_12" style="margin: 0;"> <!--bottom row-->
    <div class="col_9">
      <div id="searchresults" class="col_12"></div> <!-- End list of terms -->
    </div><!-- End left column -->
    <div class="col_3"  style="display: none; padding: 10px; opacity: 1;">
      <H6 style="margin: 0;">Min begrebsliste</H5>
  	  <div id="myList" class="col_12"></div>
  		<a id="eksporterListe" data-hint="Eksportér begrebslisten som liste" class="hint--bottom hint--no-animate icon-download" style="margin-bottom: .5em; cursor: pointer; float: right;"> Eksportér som liste <i class="icon-list" style="cursor: pointer"></i></a>
  		<a id="eksporterTabel" data-hint="Eksportér begrebslisten som tabel" class="hint--bottom hint--no-animate icon-download" style="cursor: pointer; float: right;"> Eksportér som tabel <i class="icon-table" style="cursor: pointer"></i></a>
  	</div> <!-- End right column -->
  </div><!--End content row-->
</div> <!-- End Grid -->

<!-- ===================================== START FOOTER ===================================== -->
<div class="clear"></div>
<div id="footer">
This work is licensed by <a href="http://tobias.bindslet.dk/">Tobias Bindslet</a> 2014 under a <a href="http://creativecommons.org/licenses/by-nc/3.0/">Creative Commons License</a> for attributed, non-commercial use. <BR />Built with <a href="http://www.99lime.com/elements/">HTML Kickstart</a>, <a href="http://jquery.com/">jQuery</a>, <a href="http://php.net/">PHP</a> and <a href="http://www.mysql.com/">MySQL</a>.
</div>

<script language="javascript" type="text/javascript">

  var conceptsTable;
  var userTable;
  var tagsTable;
  var availableTags = [];
  var conceptTagsTable;

  var initialize = function () {
    disableEditing(); //redigeringsmuligheder aktiveres kun ved login
    $("#myList").sortable({
      cursor: "move",
      update : function(event, ui) {
        opdaterBegrebsliste();
      }
    });
    $("#myList").disableSelection();
    sort("abc");
  }

  /* Executed when the (Google) APIs finish loading */
  function render() {
    // Load the Google+ API
    gapi.client.load('plus', 'v1').then(function() {
      document.getElementById('signin').addEventListener('click', function() {
        gapi.auth.signIn(); // Will use page level configuration
      });
      document.getElementById('signin').setAttribute('style', 'display: inline'); //unhide
    });
  }

  function signinCallback(authResult) {
    if (authResult['status']['signed_in']) {
      // Update the app to reflect a signed in user
      makeAPICall();      
    } else {
      // Update the app to reflect a signed out user
      // Possible error values:
      //   "user_signed_out" - User is signed-out
      //   "access_denied" - User denied access to your app
      //   "immediate_failed" - Could not automatically log in the user
      //console.log('Sign-in state: ' + authResult['error']);
    }
  }

  var makeAPICall = function () {
    // Assemble the API request
    var request = gapi.client.plus.people.get({userId: 'me'}).execute(handleEmailResponse);
  }
  
  var userEmail; 
  var userId;
  var userEmailAuthorized; 
  var handleEmailResponse = function (resp) {
    for (var i=0; i < resp.emails.length; i++) {
      if (resp.emails[i].type === 'account') userEmail = resp.emails[i].value;
    }
    //console.log(resp);

    //test if user exists in users table
    $.ajax({                                      
    url: 'getUser.php',             //the script to call to get data          
    data: "email=" + userEmail     //you can insert url argumnets here to pass to api.php
        + "&name=" + resp.displayName,
    dataType: 'json',               //data format      
    success: function(dbData)       //on recieve of reply
      {
        var searchOutput = "";
        var userData = dbData;

        for(var j=0; j<userData.length; j++) {
          userId = userData[j].id; //global var - used in later requests
          var name = userData[j].name;
          var firstlogin = userData[j].firstlogin;  
          var lastlogin = userData[j].lastlogin;
          var canEdit = userData[j].canedit;
        }

        if (canEdit == 1) {
          //document.getElementById('status').innerHTML += " (" + userEmail.substring(2,5).toUpperCase() + ")";
          document.getElementById('status').innerHTML = "<span class='hint--bottom hint--no-animate' data-hint='log-in godkendt - fuld adgang til at redigere i begrebsbasen'><span class='icon-ok-sign' style='color:green;'></span></span>&nbsp;" + "<span class='hint--bottom hint--no-animate noselect' data-hint='" + resp.displayName + "'>" + userEmail + "</span>";
          document.getElementById('signout').setAttribute('style', 'display: inline');
          document.getElementById('signin').setAttribute('style', 'display: none');
          if (userEmailAuthorized !== true) {
            userEmailAuthorized = true;
            enableEditing();
            refresh();
          }
        } else {
          document.getElementById('status').innerHTML = "<span class='hint--bottom hint--no-animate' data-hint='Du er logget på - men din konto har ikke adgang til at redigere.'><span class='icon-warning-sign' style='color:#FFCC00;'></span></span>&nbsp;" + "<span class='hint--bottom hint--no-animate noselect' data-hint='" + resp.displayName + "'>" + userEmail + "</span>";
          document.getElementById('signout').setAttribute('style', 'display: inline');
          document.getElementById('signin').setAttribute('style', 'display: none');
          if (userEmailAuthorized !== false) {
            userEmailAuthorized = false;
            disableEditing();
            refresh();
          }
        }
      }
    });
  }

  var signOut = function () {
    document.getElementById('signin').setAttribute('style', 'display: inline');
    document.getElementById('signout').setAttribute('style', 'display: none');
    document.getElementById('status').innerHTML = "";
    gapi.auth.signOut();
    if (userEmailAuthorized !== false) {
        userEmailAuthorized = false;
        disableEditing();
        refresh();
    }
  }

  var enableEditing = function() {
    $('button#opretButton').show(250);
  }
  
  var disableEditing = function() {
    $('button#opretButton').hide(250);
  }

  var refresh = function() {
    $('#searchresults').html("<img src='css/images/loading.gif' />");
    setTimeout(function() {
      getDB();
    }, 25);
  }
  
  var sort = function(order) {
    $("#SortAbc").removeClass("blue");
    $("#SortCba").removeClass("blue");
    $("#Sort123").removeClass("blue");
    $("#Sort321").removeClass("blue");
    if (order == "abc") {
      $("#SortAbc").addClass("blue");
    } else if (order == "cba") {
      $("#SortCba").addClass("blue");
    } else if (order == "123") {
      $("#Sort123").addClass("blue");
    } else if (order == "321") {
      $("#Sort321").addClass("blue");
    } else {
      console.log("Error: unknow sort order in sort()");
    }
    refresh();
  } 
  
  var getDB = function() {
    //-----------------------------------------------------------------------
    // 1) get tags table
    //-----------------------------------------------------------------------
    availableTags = [];
    $.ajax({                                      
      url: 'getTags.php',               //the script to call to get data          
      data: "",                       //you can insert url argumnets here to pass to api.php
                                      //for example "id=5&parent=6"
      dataType: 'json',               //data format      
      success: function(tagData)         //on recieve of reply
      {
        tagsTable = tagData;
        for(var j=0; j<tagData.length; j++) {
          availableTags.push(tagsTable[j].name);             //form array for autofill in tagsearchbox
        }
        $("#tagsearchbox").autocomplete({
          source: availableTags,
          messages: {
            noResults: '',
            results: function() {}
          }
        });
        
 
        //-----------------------------------------------------------------------
        // 2) get concepttags table
        //-----------------------------------------------------------------------
            $.ajax({                                      
          url: 'getConceptTags.php',               //the script to call to get data          
          data: "",                       //you can insert url argumnets here to pass to api.php
                                          //for example "id=5&parent=6"
          dataType: 'json',               //data format      
          success: function(conceptTagData)         //on recieve of reply
          {
            conceptTagsTable = conceptTagData;
            //-----------------------------------------------------------------------
            // 3) get concepts table
            //-----------------------------------------------------------------------
            $.ajax({                                      
              url: 'getConcepts.php',               //the script to call to get data          
              data: "",                       //you can insert url argumnets here to pass to api.php
                                              //for example "id=5&parent=6"
              dataType: 'json',               //data format      
              success: function(dbData)         //on recieve of reply
              {
                var searchOutput = "";
                conceptsTable = dbData;
                
                //sort conceptstable by name
                if ($("#SortAbc").hasClass("blue")) {
                  conceptsTable.sort(sortByNameAbc);  
                } else if ($("#SortCba").hasClass("blue")) {
                  conceptsTable.sort(sortByNameCba);
                } else if ($("#Sort123").hasClass("blue")) {
                  conceptsTable.sort(sortByUpdated123);
                } else if ($("#Sort321").hasClass("blue")) {
                  conceptsTable.sort(sortByUpdated321);
                }
                
                for(var j=0; j<conceptsTable.length; j++)
                  {
                    var id = conceptsTable[j].id;             //get id
                    var name = conceptsTable[j].name;           //get name
                    var description = conceptsTable[j].description;    //get description
                    var created = conceptsTable[j].created;        //get creation timestamp
                    var updated = conceptsTable[j].updated        //get updated timestamp
                    //var updateduserid = conceptsTable[j].updateduserid //get id of last user to update
                    if (userEmailAuthorized) {
                      searchOutput += '<div class="col_12 concept-post" style="padding: 2px 5px; margin: 3px 0px;"><div class="col_11" style="margin: 2px 5px;">'+
                      "<H6 class='concept' id='h" + id + "' contenteditable='true' style='margin: 5px 0 5px 0;'><span class='hint--right hint--no-animate' data-hint='Klik for at redigere titlen'>" + name + "</span></H6>" + 
                      "<p id='p" + id + "' contenteditable='true'><span class='hint--right hint--no-animate' data-hint='Klik for at redigere beskrivelsen'>" + description + "</span></p>" +
                      tagsHTML(id) +
                      updatedHTML(id) + 
                      '</div><div class="col_1" style="text-align: right;">' + 
                      '<span class="hint--bottom hint--no-animate" data-hint="Tilføj begrebet til din begrebsliste"><span class="icon-arrow-right" style="cursor: pointer; color: #77F;" onClick="tilføj(' + id + ')"></span></span>&nbsp;' +
                      '<span class="hint--bottom hint--no-animate" data-hint="Slet begrebet"><span class="icon-remove" style="cursor: pointer; color: red;" onClick="slet(' + id + ')"></span></span><br />' +
                      '</div></div>';
                    } else {
                      searchOutput += '<div class="col_12 concept-post" style="padding: 2px 5px; margin: 3px 0px;"><div class="col_11" style="margin: 2px 5px;">'+
                      "<H6 class='concept' id='h" + id + "' contenteditable='false' style='margin: 5px 0 5px 0;'>" + name + "</H6>" + 
                      "<p id='p" + id + "' contenteditable='false'>" + description + "</p>" +
                      tagsHTML(id) +
                      updatedHTML(id) + 
                      '</div><div class="col_1" style="text-align: right;">' + 
                      '<span class="hint--bottom hint--no-animate" data-hint="Tilføj begrebet til din begrebsliste"><span class="icon-arrow-right" style="cursor: pointer; color: #77F;" onClick="tilføj(' + id + ')"></span></span>&nbsp;' +
                      '</div></div>';
                    }
                  }
        
                //--------------------------------------------------------------------
                // 4) Update html content
                //--------------------------------------------------------------------
                $('#searchresults').html(searchOutput) //Set output element html
                $('#sortering').html("sortér " + conceptsTable.length + " begreber: ") //Set output element html
                search();
              } 
            });
          } 
        });
      } 
    });
  }; 

  var userNameFromId = function (id) {
    if (userTable == undefined) {
      //console.log("(re)loading usertable...");
      $.ajax({                                      
      url: 'getUsers.php',             //the script to call to get data          
      data: undefined,
      dataType: 'json',               //data format      
      success: function(dbData)       //on recieve of reply
        {
          userTable = dbData;
        }
      });
    }
    if (userTable !== undefined) {
      //console.log("iterating through userTable...");
      for(var j=0; j<userTable.length; j++) {
        if (userTable[j].id == id) {
          //console.log(userTable[j].id);
          return userTable[j].name;
        }
      }
      console.log("id " + id + " not found...");
    } else {
      return "Error: no usertable...";
    }
  }

  var sortByNameAbc = function (a, b) {
    var aName = a.name.toLowerCase();
    var bName = b.name.toLowerCase(); 
    return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
  }
  
  var sortByNameCba = function (a, b) {
    var aName = a.name.toLowerCase();
    var bName = b.name.toLowerCase(); 
    return ((aName > bName) ? -1 : ((aName < bName) ? 1 : 0));
  }
  
  var sortByUpdated321 = function (a, b) {
    var aUpdated = timestampToDate(a.updated)
    if (a.updated == "0000-00-00 00:00:00") {aUpdated = timestampToDate(a.created);}
    var bUpdated = timestampToDate(b.updated);
    if (b.updated == "0000-00-00 00:00:00") {bUpdated = timestampToDate(b.created);}
    return ((aUpdated < bUpdated) ? -1 : ((aUpdated > bUpdated) ? 1 : 0));
  }
  
  var sortByUpdated123 = function (a, b) {
    var aUpdated = timestampToDate(a.updated);
    if (a.updated == "0000-00-00 00:00:00") {aUpdated = timestampToDate(a.created);}
    var bUpdated = timestampToDate(b.updated);
    if (b.updated == "0000-00-00 00:00:00") {bUpdated = timestampToDate(b.created);}
    return ((aUpdated > bUpdated) ? -1 : ((aUpdated < bUpdated) ? 1 : 0));
  }

  var timestampToDate = function (t) {
    t = t.split(/[- :]/);
    return new Date(t[0], t[1]-1, t[2], t[3], t[4], t[5]);
  }

  var updatedHTML = function(id, lastupdateduserid) {
    var t = '<div class="updated col_6" style="opacity: 0.5"><span class="hint--bottom hint--no-animate" data-hint="Sidst opdateret"><i class="icon-time icon-small"></i></span> ';     
    for (index = 0; index < conceptsTable.length; ++index) {
      if (conceptsTable[index].id == id) {
        var updater = "";
        if (conceptsTable[index].updateduserid == 0) {
          updater = "anonym";
        } else {
          updater = userNameFromId(conceptsTable[index].updateduserid);
        }
        if (conceptsTable[index].updated !== "0000-00-00 00:00:00") {
          t += "opdateret for " + timeSince(timestampToDate(conceptsTable[index].updated)) + " siden af " + updater;
        } else {
          t += "opdateret for " + timeSince(timestampToDate(conceptsTable[index].created)) + " siden af " + updater;
        }
      }
    }
    t += "</div>";
    return t;
  }
  
  function timeSince(date) {
    var seconds = Math.floor((new Date() - date) / 1000);
    var interval = Math.floor(seconds / 31536000);
    if (interval > 1) {
        return interval + " år";
    }
    interval = Math.floor(seconds / 2592000);
    if (interval > 1) {
        return interval + " måneder";
    }
    interval = Math.floor(seconds / 86400);
    if (interval > 1) {
        return interval + " dage";
    }
    interval = Math.floor(seconds / 3600);
    if (interval > 1) {
        return interval + " timer";
    }
    interval = Math.floor(seconds / 60);
    if (interval > 1) {
        return interval + " minutter";
    }
    return Math.floor(seconds) + " sekunder";
  }

  var tagsHTML = function(id) {
    var t;
    if (userEmailAuthorized) {
      t = '<div class="tags"><span class="hint--bottom hint--no-animate" data-hint="Tags"><i class="icon-tags" style="opacity: 0.75; color: #06f;"></i></span> <span class="hint--bottom hint--no-animate" data-hint="Tilføj tag"><a class="icon-plus-sign" style="opacity: .75; margin-left: .5em; color: green; cursor: pointer;" onClick="tilføjTag(' + id + ')"></a></span>';     
      for (index = 0; index < conceptTagsTable.length; ++index) {
        if (conceptTagsTable[index].conceptid == id) {
          var tag = tagNameFromId(conceptTagsTable[index].tagid);
          t += ' <span class="hint--bottom hint--no-animate" data-hint="Fjern tagget ' + tag + '"><a class="icon-remove-sign" style="opacity: .75; margin-left: .5em; color: red; cursor: pointer;" onClick="fjernTag(' + conceptTagsTable[index].tagid + ', ' + id + ')"></a></span>&nbsp;<span style="opacity: 0.75; color: #06f; cursor: pointer;" onClick="tagFilter(' + conceptTagsTable[index].tagid + ')">' + tag + '</span>';
        }
      }
      t += "</div>";
    } else {
      t = '<div class="tags">';     
      for (index = 0; index < conceptTagsTable.length; ++index) {
        if (conceptTagsTable[index].conceptid == id) {
          var tag = tagNameFromId(conceptTagsTable[index].tagid);
          t += ' <span class="hint--bottom hint--no-animate" data-hint="Tags"><i class="icon-tags" style="opacity: 0.75; color: #06f;"></i></span>&nbsp;' + '<span style="opacity: 0.75; color: #06f; cursor: pointer;" onClick="tagFilter(' + conceptTagsTable[index].tagid + ')">' + tag + '</span>';
        }
      }
      t += "</div>";
    }
    return t;
  }
  
  var tagNameFromId = function (id) {
    for (i = 0; i < tagsTable.length; ++i) {
      if (tagsTable[i].id == id) {
        return tagsTable[i].name;
      }
    }
    return "";
  }
  
  var conceptNameFromId = function (id) {
    for (i = 0; i < conceptsTable.length; ++i) {
      if (conceptsTable[i].id == id) {
        return conceptsTable[i].name;
      }
    }
  }

  var tagFilter = function (id) {
    $("#tagsearchbox").val(tagNameFromId(id));
    setTimeout(function()
      {
        search();
      }, 50);
  }

  var tilføjTag = function (id) {
    $(".concept-post").each(function(i) {
      if($(this).find("h6.concept")[0].id.slice(1) == id) {
        $(this).find("a.icon-plus-sign").parent().append('<input type="search" id="tagaddbox" class="col_10" placeholder="tag du vil tilføje" />'); 
        $("#tagaddbox").autocomplete({
          source: availableTags,
          messages: {
            noResults: '',
            results: function() {}
          }
        });
        $('#tagaddbox').val('').trigger('focus');
        $("#tagaddbox").on('keydown', function(ev) {
          var t = $("#tagaddbox").val().toLowerCase();
          if ((ev.which == 13) && (t !== "")){ 
            var newTerm = true;
            for (index = 0; index < availableTags.length; ++index) {
              if (availableTags[index].toLowerCase() == t) {
                newTerm = false;
              }
            }
            if (newTerm == true) {
              // add the tag to table tags
              $.ajax({                                      
                url: 'insertTag.php',       //the script to call to get data          
                data: {name : $("#tagaddbox").val()},
                complete: function()     //on recieve of reply
                {
                  tilføjTagTilBegreb($("#tagaddbox").val(), id);
                }
              });
            } else { //tag is already in table tags
              tilføjTagTilBegreb($("#tagaddbox").val(), id);
            }
          } else if (ev.which == 27) { //esc pressed - end it
            $("#tagaddbox").remove();
          }
        });
      }
    });
  }
  
  var tilføjTagTilBegreb = function (tagToAdd, id) {
    var newConceptTerm = true;
    for (index = 0; index < conceptTagsTable.length; ++index) {
      if (conceptTagsTable[index].conceptid == id) {
        if (tagNameFromId(conceptTagsTable[index].tagid).toLowerCase() == tagToAdd.toLowerCase()) {
          newConceptTerm = false;
        }
      }
    }
    if (newConceptTerm == true) {
      // add the tag to table concepttags
      var thisTagId;
      $.ajax({                                      
        url: 'getTags.php',             //the script to call to get data          
        data: "",                       //you can insert url argumnets here to pass to api.php
        dataType: 'json',               //data format      
        success: function(tagData)     //on recieve of reply
        {
          tagsTable = tagData;
          for (index = 0; index < tagsTable.length; ++index) {
            if (tagsTable[index].name.toLowerCase() == tagToAdd.toLowerCase()) {
              thisTagId = tagsTable[index].id;
            }
          }
          if (thisTagId != 0 && thisTagId !== undefined) {
            //add tagid & conceptid to concepttags
            $.ajax({                                      
              url: 'insertConceptTag.php',       //the script to call to get data          
              data: {conceptid : id, tagid : thisTagId},
              complete: function() {
                refresh();
                $("#tagaddbox").remove();
              }
            });
          } else {
            console.log ("Error - it appears that the tag was not succesfully added to the table tags as expected?")
          }
        }
      });
    }
  }

  var fjernTag = function (tag, id) {
    fjernTagFraBegreb(tag, id);
  }
  
  var fjernTagFraBegreb = function (tag, id) {
    if (confirm("fjern tagget " + tagNameFromId(tag) + " fra " + conceptNameFromId(id) + "?")) {
      $.ajax({                                      
        url: 'deleteConceptTag.php',       //the script to call to get data          
        data: {tagid : tag, conceptid : id},
        complete: function() {
          // remove the tag from tags if no other references exist in concepttags
          var noReferences = true;
          for(var j=0; j<conceptTagsTable.length; j++) {
            if ((conceptTagsTable[j].tagid == tag) && (conceptTagsTable[j].conceptid != id)) {
              console.log("found remaining reference: " + conceptTagsTable[j].id);
              noReferences = false;
            }
          }
          if (noReferences) {//
            sletTagFraTagsTabel(tag);
          }
          refresh();
        }
      });
    }
  }
  
  var sletTagFraTagsTabel = function (tag) {
    $.ajax({                                      
      url: 'deleteTag.php',       //the script to call to get data          
      data: {id : tag},
    });
  }

  
  //
  //type anywhere to search
  //
  $(document ).on( 'keydown', function(ev) {
    var nodeName = ev.target.nodeName;
    if ( 'INPUT' == nodeName || 'TEXTAREA' == nodeName || 'P' == nodeName || 'H6' == nodeName || 'BUTTON' == nodeName) {
        return;
    } else if (ev.ctrlKey || ev.shiftKey || ev.keyCode == 33 || ev.keyCode == 34 || ev.keyCode == 35 || ev.keyCode == 36) { //allow ctrl, shift, end, home, pgup and pgdown
        return;
    } else {
      //console.log(ev.keyCode);
    }
    $( '#searchbox' ).val('').trigger('focus');
  } );
  
  
  
  //
  //Enter to add new term
  //
  $("#searchbox").on('keydown', function(ev) {
    var s = $("#searchbox").val();
    if ((ev.keyCode == 13) && (s !== "") && userEmailAuthorized){ 
      var newTerm = true;
      $(".concept-post").each(function(i) {
        if ($(this).find("h6.concept").text().search(new RegExp(s, "i")) > -1) {
          newTerm = false;
        }
      });
      if (newTerm == true) {
        opret();
      }
    } else {
      //console.log(ev.keyCode);
    }
  } );
  
  //
  //triggers events when the search box or search tag box is changed
  //
  $('#searchbox').on('focus', function() {
    var $this = $(this);
    $this.data('before', $this.val());
    return $this;
  }).on('blur keyup paste input', function() {
    var $this = $(this);
    if ($this.data('before') !== $this.val()) {
        $this.data('before', $this.val());
        $this.trigger('change');
    }
    return $this;
  }).on('change', function() {search();});
  $('#tagsearchbox').on('focus', function() {
    var $this = $(this);
    $this.data('before', $this.val());
    return $this;
  }).on('blur keyup paste input', function() {
    var $this = $(this);
    if ($this.data('before') !== $this.val()) {
        $this.data('before', $this.val());
        $this.trigger('change');
    }
    return $this;
  }).on('change', function() {search();});

  
  var search = function() {
    var s = $("#searchbox").val().toLowerCase();
    var ts = $("#tagsearchbox").val().toLowerCase();
    $(".concept-post").each(function(i) {
      var thisid = $(this).find("h6.concept")[0].id.slice(1);
      var thistags = "";
      for (index = 0; index < conceptTagsTable.length; ++index) {
        if (conceptTagsTable[index].conceptid == thisid) {
          thistags += " " + tagNameFromId(conceptTagsTable[index].tagid);
        }
      }
      if (
        (($(this).find("h6.concept").text().toLowerCase().indexOf(s) > -1) 
        || ($(this).find("p").text().toLowerCase().indexOf(s) > -1)) 
        && (thistags.toLowerCase().indexOf(ts) > -1))
      {
        //for each element in DB, hide if it doesn't have the searchterm in it's name (OR in its text) OR if it is excluded by tagfilter
        $(this).css({'display':'block'});
      } else {
        $(this).css({'display':'none'});
      }
    });
  }
  
  
  //
  //triggers events when text with contenteditable=true is changed (the edit function)
  //
  $('body').on('focus', '[contenteditable]', function() {
    var $this = $(this);
    $this.data('before', $this.html());
    return $this;
  }).on('blur keyup paste input', '[contenteditable]', function() {
    var $this = $(this);
    if ($this.data('before') !== $this.html()) {
        $this.data('before', $this.html());
        $this.trigger('change');
    }
    return $this;
  }).on('change', '[contenteditable]', function() {edit($(this));});
  
  
  //rediger begreb eller begrebsdefinition
  var edit = function(changedObject) {
    var type = changedObject.context.id.slice(0,1); //first char
    var id = changedObject.context.id.slice(1); //all but the first char
    if (type == "h") {
      $.ajax({                                      
        url: 'updateConceptName.php',       //the script to call to get data          
        data: {name : $("#h" + id).text(), id : id, uid : userId}
      });
    } else if (type == "p") {
      $.ajax({                                      
        url: 'updateConceptDescription.php',       //the script to call to get data          
        data: {description : $("#p" + id).text(), id : id, uid : userId}
      });
    } else {
      console.log ("Error - unknown type in gemRettelser");
    }
  }

  var slet = function(id) {
    $(".concept-post").each(function(i) {
      if ($(this).find("h6.concept")[0].id.slice(1) == id) {
        var begreb = $(this).find("h6.concept").text() + "?";
        if (confirm("Slet begrebet " + begreb)) {
          $(this).hide(250, function() {
            if ($(this).find("h6.concept").text() == "Nyt Begreb") {
              $("#searchbox").text("");
            }
            $.ajax({                                      
              url: 'deleteConcept.php',       //the script to call to get data          
              data: {id : id, uid : userId},
              complete: function() {
                refresh();
              }
            });
          });
        }
      }
    });
  }
  
  //opret nyt begreb
  var opret = function() {
    var name = $('#searchbox').val();
    if (name == "") {
      $('#searchbox').val("Nyt begreb");
    }
    var def = "definitionen af det nye begreb...";
    if (true) { //search box empty - opret tomt begreb
    } else {
    }
    
     $.ajax({                                      
      url: 'insertConcept.php',       //the script to call to get data          
      data: "name="+name+"&uid="+userId,
      complete: function() {
        $("#tagsearchbox").val(""); //rens filterfeltet så det nye begreb kan vises
        refresh();
      }
    });
  }
  
  //Tilføj begreb til 'min begrebsliste'
  var tilføj = function(id) {
    var newTerm = true;
    var concept;
    $(".concept-post").each(function(i) {
      if ($(this).find("h6.concept")[0].id.slice(1) == id) {
        concept = $(this).find("h6.concept").text();
      }
    });
    $(".list-post").each(function(i) {
      if ($(this).text().indexOf(concept) > -1) {
        newTerm = false;
      }
    });
    if (newTerm == true) {
      var listOutput = '<div id="h' + id + '" class="col_12 list-post" style="cursor: move; padding: 2px 2px; margin: 2px 2px;"><span class="hint--bottom hint--no-animate" data-hint="Fjern begrebet fra begrebslisten"><i style="opacity: 0.5; color: red; cursor: pointer;" class="icon-arrow-left" onClick="fjern(' + id + ')"></i></span> ' + concept + '</div>';
      $("#myList").html($("#myList").html() + listOutput); 
    }
    if ($("#myList").parent().is(":visible")) {
    } else {
      $("#myList").parent().show(500);
    }
    opdaterBegrebsliste();
  }
  
  var opdaterBegrebsliste = function () {
    jQuery('a#eksporterListe').colorbox({html : eksportTekst(), maxWidth : "700px"});
    jQuery('a#eksporterTabel').colorbox({html : eksportTabel(), maxWidth : "700px"});
  }
  
  //Fjern begreb fra 'min begrebsliste'
  var fjern = function(id) {
    $(".list-post").each(function(i) {
      if ($(this)[0].id.slice(1) == id) {
        $(this).hide(250, function() {
          $(this).remove();
          if ($(".list-post").length < 1) {
            $("#myList").parent().hide(500);
          }
          opdaterBegrebsliste();
        });
      }
    });
  }
  
  var eksportTabel = function() {
    var tekst = "";
    $("#myList").children().each(function(i) {
      var thisID = $(this)[0].id.slice(1);
      var thisName = $(this).text();
      var thisDescription = "";
      $(".concept-post").each(function(i) {
        if ($(this).find("p")[0].id.slice(1) == thisID) {
          thisDescription = $(this).find("p").text();
        }
      });
      tekst += "<tr><td><b>" + thisName + "</b></td>";
      tekst += "<td>" + thisDescription + "</td>";
    });
    tekst = "<table style='max-width: 650px;'>" + tekst + "</table>"
    return tekst;
  }
  
  var eksportTekst = function() {
    var tekst = "";
    $(".list-post").each(function(i) {
      var thisID = $(this)[0].id.slice(1);
      var thisName = $(this).text();
      var thisDescription = "";
      $(".concept-post").each(function(i) {
        if ($(this).find("p")[0].id.slice(1) == thisID) {
          thisDescription = $(this).find("p").text();
        }
      });
      tekst += "<h6>" + thisName + "</h6>";
      tekst += "<p>" + thisDescription + "</p>";
    });
    return tekst;
  }

</script>

</body>
</html>
